<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>F-gas åŒºåŸŸæ’æ”¾æ•°æ®å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        /* æ§åˆ¶é¢æ¿æ ·å¼å‡çº§ï¼šæ”¯æŒåŒé‡ç­›é€‰ */
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px; /* ä¸¤ä¸ªé€‰æ¡†ä¹‹é—´çš„è·ç¦» */
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            flex-wrap: wrap; /* æ‰‹æœºç«¯è‡ªåŠ¨æ¢è¡Œ */
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
        }
        select {
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            min-width: 180px;
        }
        
        #chart-container { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 4px; }
        .footer { text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; }
    </style>
</head>
<body>

    <h1>ğŸŒ F-gas å¤šæºåŒºåŸŸæ’æ”¾æ•°æ®å¯¹æ¯”</h1>

    <div class="controls">
        <div class="control-group">
            <label for="region-select">1. é€‰æ‹©åŒºåŸŸ (Region)</label>
            <select id="region-select">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <div class="control-group">
            <label for="substance-select">2. é€‰æ‹©ç‰©è´¨ (Substance)</label>
            <select id="substance-select">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>
    </div>

    <div id="chart-container"></div>

    <div class="footer">
        æ•°æ®æ¥æºï¼šå¤šæºå¯¹æ¯”åˆ†æ | <a href="data.csv" download>ğŸ“¥ ä¸‹è½½æºæ•°æ®</a>
    </div>

    <script>
        var myChart = echarts.init(document.getElementById('chart-container'));
        var globalData = []; // å­˜å‚¨å®Œæ•´æ•°æ®
        var distinctYears = []; // å­˜å‚¨æ‰€æœ‰å¹´ä»½

        myChart.showLoading();

        // è¯»å– data.csv (å¸¦æ—¶é—´æˆ³é˜²ç¼“å­˜)
        Papa.parse("data.csv?t=" + new Date().getTime(), {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                myChart.hideLoading();

                // --- 1. æ•°æ®æ¸…æ´— (å…³é”®æ­¥éª¤ï¼šå»ç©ºæ ¼ã€å»éšå½¢å­—ç¬¦) ---
                var rawData = results.data;
                // æ¸…æ´—è¡¨å¤´ï¼Œé˜²æ­¢ Excel å¸¦æ¥çš„ BOM é—®é¢˜
                var columns = results.meta.fields.map(function(col) {
                    return col.trim().replace(/^\ufeff/, '');
                });

                // ç®€å•çš„å®¹é”™ï¼šå¦‚æœè¡¨å¤´è¢«æ¸…æ´—äº†ï¼Œä¹Ÿè¦æŠŠæ•°æ®é‡Œçš„ key å¯¹åº”æ”¹è¿‡æ¥
                if (results.meta.fields[0] !== columns[0]) {
                    rawData = rawData.map(row => {
                        var newRow = {};
                        results.meta.fields.forEach((oldKey, index) => {
                            newRow[columns[index]] = row[oldKey];
                        });
                        return newRow;
                    });
                }

                // --- 2. æ£€æŸ¥å¿…é¡»åŒ…å«çš„åˆ— ---
                if (!columns.includes("Source") || !columns.includes("Year") || !columns.includes("Region")) {
                    alert("CSVæ ¼å¼é”™è¯¯ï¼å¿…é¡»åŒ…å« 'Year', 'Region', 'Source' ä¸‰åˆ— (æ³¨æ„é¦–å­—æ¯å¤§å†™)ã€‚");
                    return;
                }

                // --- 3. æå–ç­›é€‰é€‰é¡¹ ---
                globalData = rawData;

                // A. æå–æ‰€æœ‰å¹´ä»½ (Xè½´)
                var yearsSet = new Set(rawData.map(row => row.Year));
                distinctYears = Array.from(yearsSet).sort((a, b) => a - b);

                // B. æå–æ‰€æœ‰ç‰©è´¨ (æ’é™¤å›ºå®šåˆ—)
                var substances = columns.filter(col => col !== "Year" && col !== "Source" && col !== "Region");

                // --- 4. åˆå§‹åŒ–ä¸‹æ‹‰èœå• ---
                initSelectors(substances);
            },
            error: function(err) {
                alert("æ— æ³•è¯»å– data.csvï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸Šä¼ ã€‚");
            }
        });

        // åˆå§‹åŒ–é€‰æ‹©å™¨é€»è¾‘
        function initSelectors(substances) {
            var regionSelect = document.getElementById('region-select');
            var substanceSelect = document.getElementById('substance-select');

            // 1. å¡«å……åŒºåŸŸä¸‹æ‹‰æ¡† (è‡ªåŠ¨å»é‡)
            var regions = Array.from(new Set(globalData.map(row => row.Region))).sort();
            regionSelect.innerHTML = "";
            regions.forEach(r => {
                var opt = document.createElement("option");
                opt.value = r;
                opt.text = r;
                regionSelect.appendChild(opt);
            });

            // 2. å¡«å……ç‰©è´¨ä¸‹æ‹‰æ¡†
            substanceSelect.innerHTML = "";
            substances.forEach(s => {
                var opt = document.createElement("option");
                opt.value = s;
                opt.text = s;
                substanceSelect.appendChild(opt);
            });

            // 3. ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šå½“ä»»ä½•ä¸€ä¸ªå˜åŒ–æ—¶ï¼Œæ›´æ–°å›¾è¡¨
            regionSelect.addEventListener('change', updateChart);
            substanceSelect.addEventListener('change', updateChart);

            // 4. åˆå§‹æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾
            updateChart(); 
        }

        // æ ¸å¿ƒæ›´æ–°å‡½æ•°
        function updateChart() {
            var selectedRegion = document.getElementById('region-select').value;
            var selectedSubstance = document.getElementById('substance-select').value;

            if (!selectedRegion || !selectedSubstance) return;

            // --- æ­¥éª¤ A: ç­›é€‰å‡ºè¯¥åŒºåŸŸçš„æ•°æ® ---
            var regionData = globalData.filter(row => row.Region === selectedRegion);

            // --- æ­¥éª¤ B: åœ¨è¯¥åŒºåŸŸä¸‹ï¼Œæœ‰å“ªäº›æ¥æº (Source) ---
            var sources = Array.from(new Set(regionData.map(row => row.Source)));

            // --- æ­¥éª¤ C: æ„å»ºçº¿æ¡æ•°æ® ---
            var seriesData = sources.map(sourceName => {
                // æ‰¾å‡ºè¯¥ Source çš„æ‰€æœ‰è¡Œ
                var sourceRows = regionData.filter(row => row.Source === sourceName);
                
                // å¯¹é½å¹´ä»½æ•°æ®
                var dataPoints = distinctYears.map(year => {
                    var row = sourceRows.find(r => r.Year === year);
                    return row ? row[selectedSubstance] : null;
                });

                return {
                    name: sourceName, // å›¾ä¾‹æ˜¾ç¤ºæ¥æºå (å¦‚ EDGAR, EPA)
                    type: 'line',
                    smooth: true,
                    data: dataPoints,
                    symbolSize: 8
                };
            });

            // --- æ­¥éª¤ D: è®¾ç½®å›¾è¡¨ ---
            var option = {
                title: {
                    text: selectedRegion + ' - ' + selectedSubstance + ' æ’æ”¾å¯¹æ¯”',
                    left: 'center',
                    top: 10
                },
                tooltip: { trigger: 'axis' },
                legend: {
                    data: sources, 
                    bottom: 0,
                    padding: 20
                },
                grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    name: 'å¹´ä»½',
                    data: distinctYears
                },
                yAxis: {
                    type: 'value',
                    name: 'æ’æ”¾é‡ (å¨/CO2e)'
                },
                series: seriesData,
                color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de']
            };

            myChart.setOption(option, true); // true ä»£è¡¨å®Œå…¨é‡ç»˜
        }

        window.addEventListener('resize', () => myChart.resize());
    </script>
</body>
</html>
